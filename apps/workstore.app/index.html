<html>
    <head>
        <link rel="stylesheet" href="index.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
        <script src="/apps/libfileview.app/fileHandler.js"></script>
        <script src="/assets/libs/filer.min.js"></script> <!-- in any sane case this wouldn't be required. This isn't a sane case, Buffer doesn't work without importing this -->
        <script src="bareclient.cjs"></script>
        <script src="jszip.js"></script>
    </head>
    <body>
        <div class="container">
            <div class="sidebar">
                <button><i class="fa-solid fa-clock-rotate-left fa-lg"></i>Recent</button>
                <hr></hr>
                <button><i class="fa-solid fa-laptop fa-lg"></i>My files</button>
            </div>
            <div class="fileView">
                <div class="topbar">
                <div class="breadcrumbs"><button>Anura Repository</button><span>></span><button>apps</button></div>
                <div class="sep"></div>
                <button><i class="fa-solid fa-magnifying-glass fa-lg"></i></button>
                <button><i class="fa-solid fa-table-cells-large fa-lg"></i></button>
                <button><i class="fa-solid fa-arrow-up-a-z fa-lg"></i><!--<i class="fa-solid fa-arrow-down-z-a fa-lg"></i> - opposite--></button>
                <button><i class="fa-solid fa-ellipsis-vertical fa-lg"></i></button>
                </div>
                <hr>
                <table>
                    <thead>
                        <tr>
                            <th data-type="icon">Icon<span class="resize-handle hidden-resize-handle"></span></th>
                            <th data-type="name">Name<span class="resize-handle"></span></th>
                            <th data-type="size">Size<span class="resize-handle"></span></th>
                            <th data-type="type">Type<span class="resize-handle"></span></th>
                            <th data-type="modified">Date modified<span class="resize-handle"></span></th>
                        </tr>
                    </thead>
                    <tbody>

                    </tbody>
                </table>
            </div>
        </div>
        <script>
        // implementing it myself was too hard so i just stole it from https://codepen.io/adam-lynch/pen/GaqgXP

        const min = 150;
        // The max (fr) values for grid-template-columns
        const columnTypeToRatioMap = {
            'icon': 0.1,
            'name': 3,
            'size': 1,
            'type': 1,
            'modified': 1
        };

        const table = document.querySelector('table');
        /*
        The following will soon be filled with column objects containing
        the header element and their size value for grid-template-columns
        */
        const columns = [];
        let headerBeingResized;

        // The next three functions are mouse event callbacks

        // Where the magic happens. I.e. when they're actually resizing
        const onMouseMove = (e) => requestAnimationFrame(() => {
            console.log('onMouseMove');

            (window.getSelection ? window.getSelection() : document.selection).empty()

            // Calculate the desired width
            horizontalScrollOffset = document.documentElement.scrollLeft;
            const width = (horizontalScrollOffset + e.clientX) - headerBeingResized.offsetLeft;

            // Update the column object with the new size value
            const column = columns.find(({ header }) => header === headerBeingResized);
            column.size = Math.max(min, width) + 'px'; // Enforce our minimum

            // For the other headers which don't have a set width, fix it to their computed width
            columns.forEach((column) => {
                if(column.size.startsWith('minmax')){ // isn't fixed yet (it would be a pixel value otherwise)
                    column.size = parseInt(column.header.clientWidth, 10) + 'px';
                }
            });

            /*
                Update the column sizes
                Reminder: grid-template-columns sets the width for all columns in one value
            */
            table.style.gridTemplateColumns = columns
                .map(({ header, size }) => size)
                .join(' ');
        });

        // Clean up event listeners, classes, etc.
        const onMouseUp = () => {
            console.log('onMouseUp');

            window.removeEventListener('mousemove', onMouseMove);
            window.removeEventListener('mouseup', onMouseUp);
            headerBeingResized.classList.remove('header--being-resized');
            headerBeingResized = null;
            };

            // Get ready, they're about to resize
            const initResize = ({ target }) => {
            console.log('initResize');

            headerBeingResized = target.parentNode;
            window.addEventListener('mousemove', onMouseMove);
            window.addEventListener('mouseup', onMouseUp);
            headerBeingResized.classList.add('header--being-resized');
        };

        // Let's populate that columns array and add listeners to the resize handles
        document.querySelectorAll('th').forEach((header) => {
            const max = columnTypeToRatioMap[header.dataset.type] + 'fr';
            columns.push({
                header,
                // The initial size value for grid-template-columns:
                size: `minmax(${min}px, ${max})`,
            });
            header.querySelector('.resize-handle').addEventListener('mousedown', initResize);
        });
        </script>
        <script>
            var currentlySelected = [];
            var clipboard = []
            var removeAfterPaste = false

            window.fs = parent.anura.fs
            window.Buffer = Filer.Buffer
            let sh = new fs.Shell()

            async function loadPath(path) {
                window.client = await createBareClient(window.location.origin + '/bare/'); // this is redundant, I'll fix it later maybe
                console.debug("loading path: ", path);
                index = await (await client.fetch(path + "list.json")).json()

                await index.apps.forEach(async app => {
                    let table = document.querySelector("tbody");

                    let row = document.createElement('tr')
                    let iconContainer = document.createElement('td')
                    let icon = document.createElement('img')
                    let name = document.createElement('td')
                    let size = document.createElement('td')
                    let description = document.createElement('td')
                    let date = document.createElement('td')
                    let type = document.createElement('td')

                    name.innerText = app.name
                    description.innerText = "Anura Application"
                    date.innerText = ""
                    icon.class = '';
                    icon.src = URL.createObjectURL(await (await client.fetch(path + app.icon)).blob())
                    icon.height = '16'
                    icon.width = '16'
                    size.innerText = ""

                    iconContainer.appendChild(icon)
                    row.appendChild(iconContainer)
                    row.appendChild(name)
                    row.appendChild(size)
                    row.appendChild(description)
                    row.appendChild(date)

                    row.setAttribute("data-type", 'app');
                    row.setAttribute("data-path", `${path}${app.data}`);
                    row.setAttribute("file-name", `${app.name}.app`);
                    table.appendChild(row)

                    reloadListeners()
                })
                

                   

            }

            function reloadListeners() {
                console.debug("reloading listeners");
                console.debug(document.querySelectorAll('tr'));
                document.querySelectorAll('tr').forEach((row) => {
                    if(row.parentNode.nodeName.toLowerCase() !== "thead") {
                        console.debug("adding listeners to ", row);
                        row.addEventListener("mouseenter", (e) => {
                            e.currentTarget.classList.add("hover");
                        });
                        row.addEventListener("mouseleave", (e) => {
                            e.currentTarget.classList.remove("hover");
                        });
                        row.addEventListener("click", (e) => {
                            if(currentlySelected.includes(e.currentTarget)) {
                                fileAction(currentlySelected);
                                currentlySelected.forEach((row)=>{row.classList.remove("selected")});
                                currentlySelected = [];
                                return;
                            }
                            if(!e.shiftKey) {
                                if(!e.ctrlKey) {
                                    currentlySelected.forEach((row)=>{row.classList.remove("selected")});
                                    currentlySelected = [];
                                }
                                e.currentTarget.classList.add("selected");
                                currentlySelected.push(e.currentTarget);
                            } else {
                                if(currentlySelected.length == 0) {
                                    e.currentTarget.classList.add("selected");
                                    currentlySelected.push(e.currentTarget);
                                } else {
                                    var arr = Array.from(document.querySelectorAll('tr')).filter(row => row.parentNode.nodeName.toLowerCase() !== "thead")
                                    var firstI = arr.indexOf(currentlySelected[currentlySelected.length - 1])
                                    var lastI = arr.indexOf(e.currentTarget)
                                    var first = Math.min(firstI, lastI);
                                    var last = Math.max(firstI, lastI);
                                    for(var i = first; i <= last; i++) {
                                        if(!currentlySelected.includes(arr[i])) {
                                            currentlySelected.push(arr[i]);
                                            arr[i].classList.add("selected");
                                        }
                                    }
                                }
                            }
                        });
                    }
                });
            }

            async function fileAction(selected) {
                if(selected.length == 1) {
                    // SINGLE FILE SELECTION //

                    var fileSelected = selected[0];
                    if(fileSelected.getAttribute("data-type") == "app") {
                        new window.parent.anura.notification(
                                {
                                    title: "Anura is installing an app from a repo", 
                                    description: `Application ${fileSelected.getAttribute("file-name")} is being installed, this may take a while`, timeout: 50000
                                }).show()
                        console.debug("Clicked on app")
                        console.debug("Zip file detected, extracting")
                        const path = '/userApps/' + fileSelected.getAttribute("file-name")
                        await new fs.Shell().mkdirp(path)
                        const inputFile = await ((await client.fetch(fileSelected.getAttribute("data-path"))).blob())
                        let zip = await JSZip.loadAsync(inputFile)                                   // 1) read the Blob
                        try {
                            await zip.forEach(async function (relativePath, zipEntry) {  // 2) print entries
                                if (zipEntry.dir) {
                                    fs.mkdir(`${path}/${zipEntry.name}`)
                                } else {
                                    console.log(zipEntry)
                                    console.log(await zipEntry.async("arraybuffer"))
                                    fs.writeFile(`${path}/${zipEntry.name}`, Buffer.from(await zipEntry.async("arraybuffer")))
                                    if (zipEntry.name == "manifest.json") {
                                        await window.parent.anura.registerApp('/fs'+path)
                                        new window.parent.anura.notification(
                                        {
                                            title: "Application Installed for Session", 
                                            description: `Application ${fileSelected.getAttribute("file-name")} has been installed temporarily, it will go away on refresh`, timeout: 50000
                                        }).show()
                                    }
                                }
                            }, function (e) {
                                console.error(e)
                            })
                        } catch (e) {
                            console.error(e)
                            try {
                                await window.parent.anura.registerApp('/fs'+path)
                                new window.parent.anura.notification(
                                {
                                    title: "Application Installed for Session", 
                                    description: `Application ${fileSelected.getAttribute("file-name")} has been installed temporarily, it will go away on refresh`, timeout: 50000
                                }).show()
                            } catch (e) {
                                console.error(e)
                            }
                        }
                        




                        reload()
                        

                        
                        
                    } else if(fileSelected.getAttribute("data-type") == "dir") {
                        if (fileSelected.getAttribute("data-path").split('.').slice('-1')[0] == "app") {
                            try {
                                await window.parent.anura.registerApp(`/fs${fileSelected.getAttribute("data-path")}`.replace('//', '/'))
                                new window.parent.anura.notification({title: "Application Installed for Session", description: `Application ${fileSelected.getAttribute("data-path").replace('//', '/')} has been installed temporarily, it will go away on refresh`, timeout: 50000}).show()
                            } catch (e) {
                                new window.parent.anura.notification({title: "Application Install Error", description: `Application had an error installing: ${e}`, timeout: 50000}).show()    
                            }
                            
                            
                        } else {
                            console.debug("Changing folder to ", fileSelected.getAttribute("data-path"));
                            loadPath(fileSelected.getAttribute("data-path"));
                        }

                    } else {
                        console.warn("Unknown filetype ", fileSelected.getAttribute("data-type"), " doing nothing!");
                    }
                } else {
                    // MULTIPLE FILE SELECTION //

                    console.error("raff please implement"); 
                }
            }

            function setBreadcrumbs(path) {
                path = path.replace(/(\/)\1+/g, '$1')
                var pathSplit = path.split("/");
                console.log(pathSplit);
                pathSplit[0] = "My files";
                var breadcrumbs = document.querySelector(".breadcrumbs");
                breadcrumbs.setAttribute("data-current-path", path);
                breadcrumbs.innerHTML = '';
                if(pathSplit.length == 2 && pathSplit[0] == "My files" && pathSplit[1] == "") {
                    var breadcrumb = document.createElement("button");
                    breadcrumb.innerText = "My files";
                    breadcrumb.addEventListener("click", () => {
                        loadPath('/');
                    });
                    breadcrumbs.appendChild(breadcrumb);
                    return;
                }
                for(var i = 0; i<pathSplit.length; i++) {
                    console.log(i);
                    var breadcrumb = document.createElement("button");
                    breadcrumb.innerText = pathSplit[i];
                    var index = i;
                    breadcrumb.addEventListener("click", () => {
                        loadPath('/' + pathSplit.slice(1, index).join('/'));
                    });
                    breadcrumbs.appendChild(breadcrumb)
                    if(pathSplit[i] !== pathSplit[pathSplit.length-1]) {
                        var breadcrumbSpan = document.createElement("span");
                        breadcrumbSpan.innerText = ">";
                        breadcrumbs.appendChild(breadcrumbSpan);
                    }
                }
            }

            document.querySelector("table").addEventListener("click", (e) => {
                if(e.currentTarget === e.target) {
                    currentlySelected.forEach((row)=>{row.classList.remove("selected")});
                    currentlySelected = [];
                }
            });
            document.addEventListener("contextmenu", (e) => {
                if(e.shiftKey) {
                    return;
                }
                e.preventDefault();
                var contextmenu = document.querySelector("#contextMenu");
                contextmenu.style.left = e.pageX + "px";
                contextmenu.style.top = e.pageY + "px";
                contextmenu.style.removeProperty("display");
            });

            document.addEventListener("click", (e) => {
                if(e.target !== document.querySelector("#contextMenu") || !document.querySelector("#contextMenu").contains(e.target)) {
                    document.querySelector("#contextMenu").style.setProperty("display", "none");
                }
            });
            function newFolder(path) {
                if (path === undefined) {
                    path = document.querySelector(".breadcrumbs").getAttribute("data-current-path") + '/' + prompt('Folder Name: ')
                }
                fs.mkdir(path)
                reload()
            }
            function reload() {
                loadPath(document.querySelector(".breadcrumbs").getAttribute("data-current-path"))
            }
            function reload() {
                loadPath(document.querySelector(".breadcrumbs").getAttribute("data-current-path"))
            }

            function upload() {
                
                let fauxput = document.createElement('input') // fauxput - fake input that isn't shown or ever added to page TODO: think of a better name for this variable
                fauxput.type = 'file'
                fauxput.onchange = async (e) => {
                    const file = await e.target.files[0]
                    const content = await file.arrayBuffer()
                    fs.writeFile(`${document.querySelector(".breadcrumbs").getAttribute("data-current-path")}/${file.name}`, Buffer.from(content), function (err) {
                        reload();
                    })
                }
                fauxput.click()
            }
            function deleteFile() {
                if (currentlySelected.length == 0) {
                    alert("BUG: You have no files selected, right clicking does not select files")   
                }
                currentlySelected.forEach(async item => {
                    await sh.rm(item.getAttribute("data-path"), { recursive: true }, function(err) {
                        if(err) throw err;
                        reload()
                    })
                    
                })
            }
            function copy() {
                clipboard = currentlySelected
                removeAfterPaste = false
            }
            function cut() {
                clipboard = currentlySelected
                removeAfterPaste = true
            }
            function paste() {
                const path = document.querySelector(".breadcrumbs").getAttribute("data-current-path")
                if (!removeAfterPaste) { // copy
                    alert("Copy Paste is not Implimented, please use cut")
                }
                if (removeAfterPaste) {  // cut
                    clipboard.forEach(item => {
                        itemName = item.getAttribute("data-path")
                        fs.rename(itemName, `${path}/${itemName.split("/").slice("-1")[0]}`, function(err) {
                            if(err) throw err;
                            reload()
                        });
                    })
                }
            }
            loadPath('https://8000-mercuryworkshop-alicewm-rmklwfllsv5.ws-us99.gitpod.io/');

        </script>
        <div style="display: none;" id="contextMenu">
            <button>Get info</button>
            <button>Pin to shelf</button>
            <button onclick="reload()">Refresh</button>
            <hr></hr>
            <button onclick="cut()">Cut</button>
            <button onclick="copy()">Copy</button>
            <button  onclick="paste()">Paste</button>
            <button onclick="deleteFile()">Delete</button>
            <button onclick="upload()">Upload from PC</button>
            <hr></hr>
            <button onclick="newFolder()">New folder</button>
        </div>
    </body>
</html>
