<html>

<head>
    <link rel="stylesheet" href="index.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="/apps/libfileview.app/fileHandler.js"></script>
    <script src="/assets/libs/filer.min.js"></script>
    <!-- in any sane case this wouldn't be required. This isn't a sane case, Buffer doesn't work without importing this -->
    <script src="bareclient.cjs"></script>
    <script src="jszip.js"></script>
</head>

<body>
    <div class="container">
        <div class="sidebar">
            <textarea name="" id="repos">https://8000-mercuryworkshop-alicewm-rmklwfllsv5.ws-us99.gitpod.io/</textarea>
            <button type="button" onclick="loadPathFromUser()">Reload</button>
        </div>
        <div class="fileView">
            <div class="topbar">
                <div class="breadcrumbs"><button>Anura Repository</button><span>></span><button>apps</button></div>
                <div class="sep"></div>
                <button><i class="fa-solid fa-magnifying-glass fa-lg"></i></button>
                <button><i class="fa-solid fa-table-cells-large fa-lg"></i></button>
                <button><i
                        class="fa-solid fa-arrow-up-a-z fa-lg"></i><!--<i class="fa-solid fa-arrow-down-z-a fa-lg"></i> - opposite--></button>
                <button><i class="fa-solid fa-ellipsis-vertical fa-lg"></i></button>
            </div>
            <hr>
            <table>
                <thead>
                    <tr>
                        <th data-type="icon">Icon<span class="resize-handle hidden-resize-handle"></span></th>
                        <th data-type="name">Name<span class="resize-handle"></span></th>
                        <th data-type="type">Type<span class="resize-handle"></span></th>

                    </tr>
                </thead>
                <tbody>

                </tbody>
            </table>
        </div>
    </div>
    <script>
        // implementing it myself was too hard so i just stole it from https://codepen.io/adam-lynch/pen/GaqgXP

        const min = 150;
        // The max (fr) values for grid-template-columns
        const columnTypeToRatioMap = {
            'icon': 0.1,
            'name': 3,
            'type': 1,
        };

        const table = document.querySelector('table');
        /*
        The following will soon be filled with column objects containing
        the header element and their size value for grid-template-columns
        */
        const columns = [];
        let headerBeingResized;

        // The next three functions are mouse event callbacks

        // Where the magic happens. I.e. when they're actually resizing
        const onMouseMove = (e) => requestAnimationFrame(() => {
            console.log('onMouseMove');

            (window.getSelection ? window.getSelection() : document.selection).empty()

            // Calculate the desired width
            horizontalScrollOffset = document.documentElement.scrollLeft;
            const width = (horizontalScrollOffset + e.clientX) - headerBeingResized.offsetLeft;

            // Update the column object with the new size value
            const column = columns.find(({header}) => header === headerBeingResized);
            column.size = Math.max(min, width) + 'px'; // Enforce our minimum

            // For the other headers which don't have a set width, fix it to their computed width
            columns.forEach((column) => {
                if (column.size.startsWith('minmax')) { // isn't fixed yet (it would be a pixel value otherwise)
                    column.size = parseInt(column.header.clientWidth, 10) + 'px';
                }
            });

            /*
                Update the column sizes
                Reminder: grid-template-columns sets the width for all columns in one value
            */
            table.style.gridTemplateColumns = columns
                .map(({header, size}) => size)
                .join(' ');
        });

        // Clean up event listeners, classes, etc.
        const onMouseUp = () => {
            console.log('onMouseUp');

            window.removeEventListener('mousemove', onMouseMove);
            window.removeEventListener('mouseup', onMouseUp);
            headerBeingResized.classList.remove('header--being-resized');
            headerBeingResized = null;
        };

        // Get ready, they're about to resize
        const initResize = ({target}) => {
            console.log('initResize');

            headerBeingResized = target.parentNode;
            window.addEventListener('mousemove', onMouseMove);
            window.addEventListener('mouseup', onMouseUp);
            headerBeingResized.classList.add('header--being-resized');
        };

        // Let's populate that columns array and add listeners to the resize handles
        document.querySelectorAll('th').forEach((header) => {
            const max = columnTypeToRatioMap[header.dataset.type] + 'fr';
            columns.push({
                header,
                // The initial size value for grid-template-columns:
                size: `minmax(${min}px, ${max})`,
            });
            header.querySelector('.resize-handle').addEventListener('mousedown', initResize);
        });
    </script>
    <script>
        var currentlySelected = [];
        var clipboard = []
        var removeAfterPaste = false

        window.fs = parent.anura.fs
        window.Buffer = Filer.Buffer
        let sh = new fs.Shell()

        async function loadPath(path) {
            window.client = await createBareClient(window.location.origin + '/bare/'); // this is redundant, I'll fix it later maybe
            console.debug("loading path: ", path);
            index = await (await client.fetch(path + "list.json")).json()

            await index.apps.forEach(async app => {
                let table = document.querySelector("tbody");

                let row = document.createElement('tr')
                let iconContainer = document.createElement('td')
                let icon = document.createElement('img')
                let name = document.createElement('td')
                // let size = document.createElement('td')
                let description = document.createElement('td')
                // let date = document.createElement('td')
                let type = document.createElement('td')

                name.innerText = app.name
                description.innerText = "Anura Application"
                icon.class = '';
                icon.src = URL.createObjectURL(await (await client.fetch(path + app.icon)).blob())
                icon.height = '16'
                icon.width = '16'

                iconContainer.appendChild(icon)
                row.appendChild(iconContainer)
                row.appendChild(name)
                row.appendChild(description)

                row.setAttribute("data-type", 'app');
                row.setAttribute("data-path", `${path}${app.data}`);
                row.setAttribute("file-name", `${app.name}.app`);
                table.appendChild(row)

                reloadListeners()
            })
        }

        function reloadListeners() {
            console.debug("reloading listeners");
            console.debug(document.querySelectorAll('tr'));
            document.querySelectorAll('tr').forEach((row) => {
                if (row.parentNode.nodeName.toLowerCase() !== "thead") {
                    console.debug("adding listeners to ", row);
                    row.addEventListener("mouseenter", (e) => {
                        e.currentTarget.classList.add("hover");
                    });
                    row.addEventListener("mouseleave", (e) => {
                        e.currentTarget.classList.remove("hover");
                    });
                    row.addEventListener("click", (e) => {
                        if (currentlySelected.includes(e.currentTarget)) {
                            fileAction(currentlySelected);
                            currentlySelected.forEach((row) => {row.classList.remove("selected")});
                            currentlySelected = [];
                            return;
                        }
                        if (!e.shiftKey) {
                            if (!e.ctrlKey) {
                                currentlySelected.forEach((row) => {row.classList.remove("selected")});
                                currentlySelected = [];
                            }
                            e.currentTarget.classList.add("selected");
                            currentlySelected.push(e.currentTarget);
                        } else {
                            if (currentlySelected.length == 0) {
                                e.currentTarget.classList.add("selected");
                                currentlySelected.push(e.currentTarget);
                            } else {
                                var arr = Array.from(document.querySelectorAll('tr')).filter(row => row.parentNode.nodeName.toLowerCase() !== "thead")
                                var firstI = arr.indexOf(currentlySelected[currentlySelected.length - 1])
                                var lastI = arr.indexOf(e.currentTarget)
                                var first = Math.min(firstI, lastI);
                                var last = Math.max(firstI, lastI);
                                for (var i = first; i <= last; i++) {
                                    if (!currentlySelected.includes(arr[i])) {
                                        currentlySelected.push(arr[i]);
                                        arr[i].classList.add("selected");
                                    }
                                }
                            }
                        }
                    });
                }
            });
        }

        async function fileAction(selected) {
            if (selected.length == 1) {
                // SINGLE FILE SELECTION //

                var fileSelected = selected[0];
                if (fileSelected.getAttribute("data-type") == "app") {
                    anura.notifications.add(
                        {
                            title: "Anura is installing an app from a repo",
                            description: `Application ${fileSelected.getAttribute("file-name")} is being installed, this may take a while`,
                            timeout: 50000
                        })
                    console.debug("Clicked on app")
                    console.debug("Zip file detected, extracting")
                    const path = '/userApps/' + fileSelected.getAttribute("file-name")
                    await new fs.Shell().mkdirp(path)
                    const inputFile = await ((await client.fetch(fileSelected.getAttribute("data-path"))).blob())
                    let zip = await JSZip.loadAsync(inputFile)                                   // 1) read the Blob
                    try {
                        await zip.forEach(async function (relativePath, zipEntry) {  // 2) print entries
                            if (zipEntry.dir) {
                                fs.mkdir(`${path}/${zipEntry.name}`)
                            } else {
                                console.log(zipEntry)
                                console.log(await zipEntry.async("arraybuffer"))
                                fs.writeFile(`${path}/${zipEntry.name}`, Buffer.from(await zipEntry.async("arraybuffer")))
                                if (zipEntry.name == "manifest.json") {
                                    await anura.registerApp('/fs' + path)
                                    anura.notifications.add(
                                        {
                                            title: "Application Installed for Session",
                                            description: `Application ${fileSelected.getAttribute("file-name")} has been installed temporarily, it will go away on refresh`,
                                            timeout: 50000
                                        })
                                }
                            }
                        }, function (e) {
                            anura.notifications.add({
                                title: "Application ZIP extraction error",
                                description: `Application had an error installing: ${e}`,
                                timeout: 50000
                            })
                            console.error(e)
                        })
                    } catch (e) {
                        console.error(e)
                        try {
                            await anura.registerApp('/fs' + path)
                            anura.notifications.add(
                                {
                                    title: "Application Installed for Session",
                                    description: `Application ${fileSelected.getAttribute("file-name")} has been installed temporarily, it will go away on refresh`,
                                    timeout: 50000
                                })
                        } catch (e) {
                            anura.notifications.add({
                                title: "Application Install Error",
                                description: `Application had an error installing: ${e}`,
                                timeout: 50000
                            })
                        }
                    }
                    reload()
                }
            }
        }



        document.querySelector("table").addEventListener("click", (e) => {
            if (e.currentTarget === e.target) {
                currentlySelected.forEach((row) => {row.classList.remove("selected")});
                currentlySelected = [];
            }
        });

        function loadPathFromUser() {
            document.getElementById('repos').value.split('\n').forEach(repo => {
                try {
                    console.log('Repo being loaded ' + repo)
                    loadPath(repo);
                } catch (e) {
                    anura.notifications.add({
                        title: "Failed to load repo",
                        description: `Repo ${repo} failed to load: ${e}`,
                        timeout: 50000
                    })
                }
            })
        }
        loadPathFromUser()

    </script>
</body>

</html>
